import { create } from 'zustand'
import { persist } from 'zustand/middleware'
import { Transaction, Category, FilterOptions } from '@/types'
import toast from 'react-hot-toast'

interface FinancialState {
  transactions: Transaction[]
  categories: Category[]
  addTransaction: (transaction: Omit<Transaction, 'id' | 'createdAt'>) => void
  updateTransaction: (id: string, transaction: Partial<Transaction>) => void
  deleteTransaction: (id: string) => void
  addCategory: (category: Omit<Category, 'id'>) => void
  updateCategory: (id: string, category: Partial<Category>) => void
  deleteCategory: (id: string) => void
  getFilteredTransactions: (filters: FilterOptions) => Transaction[]
  initializeDefaultData: () => void
}

const defaultCategories: Omit<Category, 'userId'>[] = [
  { id: '1', name: 'Salário', type: 'income', color: '#22c55e', icon: 'DollarSign' },
  { id: '2', name: 'Freelance', type: 'income', color: '#10b981', icon: 'Briefcase' },
  { id: '3', name: 'Investimentos', type: 'income', color: '#14b8a6', icon: 'TrendingUp' },
  { id: '4', name: 'Alimentação', type: 'expense', color: '#ef4444', icon: 'UtensilsCrossed' },
  { id: '5', name: 'Transporte', type: 'expense', color: '#f97316', icon: 'Car' },
  { id: '6', name: 'Moradia', type: 'expense', color: '#dc2626', icon: 'Home' },
  { id: '7', name: 'Lazer', type: 'expense', color: '#ec4899', icon: 'Gamepad2' },
  { id: '8', name: 'Saúde', type: 'expense', color: '#8b5cf6', icon: 'Heart' },
  { id: '9', name: 'Educação', type: 'expense', color: '#6366f1', icon: 'GraduationCap' },
]

export const useFinancialStore = create<FinancialState>()(
  persist(
    (set, get) => ({
      transactions: [],
      categories: [],

      initializeDefaultData: () => {
        const state = get()
        if (state.categories.length === 0) {
          set({
            categories: defaultCategories.map(cat => ({ ...cat, userId: '1' })),
          })
        }
      },

      addTransaction: (transaction) => {
        const newTransaction: Transaction = {
          ...transaction,
          id: Date.now().toString(),
          createdAt: new Date().toISOString(),
        }
        set((state) => ({
          transactions: [newTransaction, ...state.transactions],
        }))
        toast.success('Transação adicionada com sucesso')
      },

      updateTransaction: (id, updatedData) => {
        set((state) => ({
          transactions: state.transactions.map((t) =>
            t.id === id ? { ...t, ...updatedData } : t
          ),
        }))
        toast.success('Transação atualizada com sucesso')
      },

      deleteTransaction: (id) => {
        set((state) => ({
          transactions: state.transactions.filter((t) => t.id !== id),
        }))
        toast.success('Transação excluída com sucesso')
      },

      addCategory: (category) => {
        const newCategory: Category = {
          ...category,
          id: Date.now().toString(),
        }
        set((state) => ({
          categories: [...state.categories, newCategory],
        }))
        toast.success('Categoria criada com sucesso')
      },

      updateCategory: (id, updatedData) => {
        set((state) => ({
          categories: state.categories.map((c) =>
            c.id === id ? { ...c, ...updatedData } : c
          ),
        }))
        toast.success('Categoria atualizada com sucesso')
      },

      deleteCategory: (id) => {
        const state = get()
        const hasTransactions = state.transactions.some(t => t.categoryId === id)
        
        if (hasTransactions) {
          toast.error('Não é possível excluir uma categoria com transações')
          return
        }

        set((state) => ({
          categories: state.categories.filter((c) => c.id !== id),
        }))
        toast.success('Categoria excluída com sucesso')
      },

      getFilteredTransactions: (filters) => {
        const { transactions } = get()
        let filtered = [...transactions]

        if (filters.type && filters.type !== 'all') {
          filtered = filtered.filter((t) => t.type === filters.type)
        }

        if (filters.categoryId) {
          filtered = filtered.filter((t) => t.categoryId === filters.categoryId)
        }

        if (filters.startDate) {
          filtered = filtered.filter((t) => t.date >= filters.startDate!)
        }

        if (filters.endDate) {
          filtered = filtered.filter((t) => t.date <= filters.endDate!)
        }

        if (filters.searchTerm) {
          const term = filters.searchTerm.toLowerCase()
          filtered = filtered.filter(
            (t) =>
              t.description.toLowerCase().includes(term) ||
              t.category.toLowerCase().includes(term)
          )
        }

        return filtered
      },
    }),
    {
      name: 'financial-storage',
    }
  )
)

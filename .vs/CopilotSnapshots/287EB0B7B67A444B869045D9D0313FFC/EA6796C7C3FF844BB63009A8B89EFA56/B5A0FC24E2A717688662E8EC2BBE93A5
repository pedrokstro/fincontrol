import { create } from 'zustand'
import { persist } from 'zustand/middleware'
import { Transaction, Category, FilterOptions } from '@/types'
import toast from 'react-hot-toast'

interface FinancialState {
  transactions: Transaction[]
  categories: Category[]
  addTransaction: (transaction: Omit<Transaction, 'id' | 'createdAt'>) => void
  updateTransaction: (id: string, transaction: Partial<Transaction>) => void
  deleteTransaction: (id: string) => void
  addCategory: (category: Omit<Category, 'id'>) => void
  updateCategory: (id: string, category: Partial<Category>) => void
  deleteCategory: (id: string) => void
  getFilteredTransactions: (filters: FilterOptions) => Transaction[]
  initializeDefaultData: () => void
}

const defaultCategories: Omit<Category, 'userId'>[] = [
  // Income Categories
  { id: '1', name: 'Salário', type: 'income', color: '#22c55e', icon: 'DollarSign' },
  { id: '2', name: 'Freelance', type: 'income', color: '#10b981', icon: 'Briefcase' },
  { id: '3', name: 'Investimentos', type: 'income', color: '#14b8a6', icon: 'TrendingUp' },
  { id: '4', name: 'Bônus', type: 'income', color: '#0ea5e9', icon: 'BadgeDollarSign' },
  { id: '5', name: 'Presentes', type: 'income', color: '#06b6d4', icon: 'Gift' },
  
  // Food & Dining
  { id: '10', name: 'Alimentação', type: 'expense', color: '#ef4444', icon: 'UtensilsCrossed' },
  { id: '11', name: 'Restaurante', type: 'expense', color: '#f97316', icon: 'Pizza' },
  { id: '12', name: 'Café & Lanches', type: 'expense', color: '#fb923c', icon: 'Coffee' },
  { id: '13', name: 'Supermercado', type: 'expense', color: '#dc2626', icon: 'Apple' },
  
  // Transportation
  { id: '20', name: 'Transporte', type: 'expense', color: '#3b82f6', icon: 'Car' },
  { id: '21', name: 'Combustível', type: 'expense', color: '#2563eb', icon: 'Fuel' },
  { id: '22', name: 'Transporte Público', type: 'expense', color: '#1d4ed8', icon: 'Bus' },
  { id: '23', name: 'Uber/Taxi', type: 'expense', color: '#60a5fa', icon: 'MapPin' },
  
  // Housing
  { id: '30', name: 'Moradia', type: 'expense', color: '#8b5cf6', icon: 'Home' },
  { id: '31', name: 'Aluguel/Financiamento', type: 'expense', color: '#7c3aed', icon: 'Building' },
  { id: '32', name: 'Contas de Luz', type: 'expense', color: '#a78bfa', icon: 'Zap' },
  { id: '33', name: 'Contas de Água', type: 'expense', color: '#6366f1', icon: 'Droplets' },
  { id: '34', name: 'Internet', type: 'expense', color: '#818cf8', icon: 'Wifi' },
  { id: '35', name: 'Manutenção', type: 'expense', color: '#4f46e5', icon: 'Hammer' },
  
  // Entertainment & Leisure
  { id: '40', name: 'Lazer', type: 'expense', color: '#ec4899', icon: 'Gamepad2' },
  { id: '41', name: 'Compras', type: 'expense', color: '#f472b6', icon: 'ShoppingBag' },
  { id: '42', name: 'Cinema/Shows', type: 'expense', color: '#db2777', icon: 'Film' },
  { id: '43', name: 'Viagens', type: 'expense', color: '#be185d', icon: 'Palmtree' },
  { id: '44', name: 'Streaming', type: 'expense', color: '#f9a8d4', icon: 'FileCheck' },
  
  // Health & Wellness
  { id: '50', name: 'Saúde', type: 'expense', color: '#f43f5e', icon: 'Heart' },
  { id: '51', name: 'Farmácia', type: 'expense', color: '#e11d48', icon: 'Pill' },
  { id: '52', name: 'Academia', type: 'expense', color: '#fb7185', icon: 'Dumbbell' },
  { id: '53', name: 'Consultas Médicas', type: 'expense', color: '#be123c', icon: 'Stethoscope' },
  
  // Education
  { id: '60', name: 'Educação', type: 'expense', color: '#0891b2', icon: 'GraduationCap' },
  { id: '61', name: 'Cursos', type: 'expense', color: '#06b6d4', icon: 'Laptop' },
  { id: '62', name: 'Livros', type: 'expense', color: '#22d3ee', icon: 'BookOpen' },
  
  // Personal Care
  { id: '70', name: 'Cuidados Pessoais', type: 'expense', color: '#a855f7', icon: 'Sparkles' },
  { id: '71', name: 'Cabelo & Beleza', type: 'expense', color: '#9333ea', icon: 'Scissors' },
  
  // Technology & Bills
  { id: '80', name: 'Celular', type: 'expense', color: '#64748b', icon: 'Smartphone' },
  { id: '81', name: 'Cartão de Crédito', type: 'expense', color: '#475569', icon: 'CreditCard' },
  
  // Pets
  { id: '90', name: 'Pets', type: 'expense', color: '#ea580c', icon: 'Dog' },
  
  // Other
  { id: '100', name: 'Outros', type: 'expense', color: '#71717a', icon: 'Package' },
]

export const useFinancialStore = create<FinancialState>()(
  persist(
    (set, get) => ({
      transactions: [],
      categories: [],

      initializeDefaultData: () => {
        const state = get()
        if (state.categories.length === 0) {
          set({
            categories: defaultCategories.map(cat => ({ ...cat, userId: '1' })),
          })
        }
      },

      addTransaction: (transaction) => {
        const newTransaction: Transaction = {
          ...transaction,
          id: Date.now().toString(),
          createdAt: new Date().toISOString(),
        }
        set((state) => ({
          transactions: [newTransaction, ...state.transactions],
        }))
        toast.success('Transação adicionada com sucesso')
      },

      updateTransaction: (id, updatedData) => {
        set((state) => ({
          transactions: state.transactions.map((t) =>
            t.id === id ? { ...t, ...updatedData } : t
          ),
        }))
        toast.success('Transação atualizada com sucesso')
      },

      deleteTransaction: (id) => {
        set((state) => ({
          transactions: state.transactions.filter((t) => t.id !== id),
        }))
        toast.success('Transação excluída com sucesso')
      },

      addCategory: (category) => {
        const newCategory: Category = {
          ...category,
          id: Date.now().toString(),
        }
        set((state) => ({
          categories: [...state.categories, newCategory],
        }))
        toast.success('Categoria criada com sucesso')
      },

      updateCategory: (id, updatedData) => {
        set((state) => ({
          categories: state.categories.map((c) =>
            c.id === id ? { ...c, ...updatedData } : c
          ),
        }))
        toast.success('Categoria atualizada com sucesso')
      },

      deleteCategory: (id) => {
        const state = get()
        const hasTransactions = state.transactions.some(t => t.categoryId === id)
        
        if (hasTransactions) {
          toast.error('Não é possível excluir uma categoria com transações')
          return
        }

        set((state) => ({
          categories: state.categories.filter((c) => c.id !== id),
        }))
        toast.success('Categoria excluída com sucesso')
      },

      getFilteredTransactions: (filters) => {
        const { transactions } = get()
        let filtered = [...transactions]

        if (filters.type && filters.type !== 'all') {
          filtered = filtered.filter((t) => t.type === filters.type)
        }

        if (filters.categoryId) {
          filtered = filtered.filter((t) => t.categoryId === filters.categoryId)
        }

        if (filters.startDate) {
          filtered = filtered.filter((t) => t.date >= filters.startDate!)
        }

        if (filters.endDate) {
          filtered = filtered.filter((t) => t.date <= filters.endDate!)
        }

        if (filters.searchTerm) {
          const term = filters.searchTerm.toLowerCase()
          filtered = filtered.filter(
            (t) =>
              t.description.toLowerCase().includes(term) ||
              t.category.toLowerCase().includes(term)
          )
        }

        return filtered
      },
    }),
    {
      name: 'financial-storage',
    }
  )
)
